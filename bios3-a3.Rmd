---
title: "Biostatistics 3 Assignment 3"
author: "Kevin Lee (LXXKEV004)"
date: "03/06/2021"
output: pdf_document
bibliography: references.bib
---

Data file used for this assignment: *assign1_data18.csv*

``` {r setup, include = FALSE}

library(readxl)
library(plyr)
library(dplyr)
library(survival)
library(survminer)
library(rms)
library(broom)

```

``` {r read_data, include = FALSE}
# Read in data
path <- list.files("in", full.names = T)
d <- read_excel(path)

summary(d)
d %>% count(sex)
d %>% count(chf)
d %>% count(yrgrp)

```

``` {r cph_age, include = FALSE}
# Age
# Distribution
cox_univ_age <- coxph(
  Surv(time = lenfol, event = fstat) ~ age,
  data = d
)

summary(cox_univ_age)

# Function to get univariate tidy output
cox_tidy <-  function(model) {
  tidy(model, exponentiate = T, conf.int = T) %>%
    mutate(
      exp = paste0(
        round(estimate, 2), " (", round(conf.low, 2), ", ", round(conf.high, 2), ")")) %>% 
    select(term, exp)
}

cox_tidy(cox_univ_age)

```

``` {r cph_sex, include = FALSE}
# Sex (1 == female)
cox_univ_sex <- coxph(
  Surv(time = lenfol, event = fstat) ~ sex,
  data = d
)

summary(cox_univ_sex)

cox_tidy(cox_univ_sex)
```

``` {r cph_los, include = FALSE}
# Length of stay
cox_univ_los <- coxph(
  Surv(time = lenfol, event = fstat) ~ lenstay,
  data = d
)

summary(cox_univ_los)

cox_tidy(cox_univ_los)
```

``` {r cox_cohort, include = FALSE}
# Grouped cohort year
cox_univ_cohort <- coxph(
  Surv(time = lenfol, event = fstat) ~ yrgrp,
  data = d
)

summary(cox_univ_cohort)

cox_tidy(cox_univ_cohort)
```

``` {r cph_chf, include = FALSE}
# Heart failure complications
cox_univ_chf <- coxph(
  Surv(time = lenfol, event = fstat) ~ chf,
  data = d
)

summary(cox_univ_chf)

cox_tidy(cox_univ_chf)
```

``` {r cph_multi, include = FALSE}
cox_multi <- coxph(
  Surv(time = lenfol, event = fstat) ~ age + sex + lenstay + yrgrp + chf,
  data = d
)

summary(cox_multi)

cox_tidy(cox_multi)

```

``` {r exp_age, include = FALSE}
exp_age <- survreg(
  Surv(time = lenfol, event = fstat) ~ age,
  data = d,
  dist = "exponential"
)

summary(exp_age)

tidy(exp_age, conf.int = T)
```

``` {r exp_sex, include = FALSE}
exp_sex <- survreg(
  Surv(time = lenfol, event = fstat) ~ sex,
  data = d,
  dist = "exponential"
)

summary(exp_sex)

tidy(exp_sex, conf.int = T)
```

``` {r exp_los, include = FALSE}
exp_los <- survreg(
  Surv(time = lenfol, event = fstat) ~ lenstay,
  data = d,
  dist = "exponential"
)

summary(exp_los)

tidy(exp_los, conf.int = T)
```

``` {r exp_cohort, include = FALSE}
exp_cohort <- survreg(
  Surv(time = lenfol, event = fstat) ~ yrgrp,
  data = d,
  dist = "exponential"
)

summary(exp_cohort)

tidy(exp_cohort, conf.int = T)
```

``` {r exp_chf, include = FALSE}
exp_chf <- survreg(
  Surv(time = lenfol, event = fstat) ~ chf,
  data = d,
  dist = "exponential"
)

summary(exp_chf)

tidy(exp_chf, conf.int = T)
```

``` {r exp_multi, include = FALSE}
exp_multi <- survreg(
  Surv(time = lenfol, event = fstat) ~ age + sex + lenstay + yrgrp + chf,
  data = d,
  dist = "exponential"
)

summary(exp_multi)

tidy(exp_multi, conf.int = T)
```

``` {r weibull_age, include = FALSE}
weibull_age <- survreg(
  Surv(time = lenfol, event = fstat) ~ age,
  data = d,
  dist = "weibull"
)

summary(weibull_age)

tidy(weibull_age, conf.int = T)
```

``` {r weibull_sex, include = FALSE}
exp_sex <- survreg(
  Surv(time = lenfol, event = fstat) ~ sex,
  data = d,
  dist = "exponential"
)

summary(exp_sex)

tidy(exp_sex, conf.int = T)
```

``` {r weibull_los, include = FALSE}
weibull_los <- survreg(
  Surv(time = lenfol, event = fstat) ~ lenstay,
  data = d,
  dist = "weibull"
)

summary(weibull_los)

tidy(weibull_los, conf.int = T)
```

``` {r weibull_cohort, include = FALSE}
weibull_cohort <- survreg(
  Surv(time = lenfol, event = fstat) ~ yrgrp,
  data = d,
  dist = "weibull"
)

summary(weibull_cohort)

tidy(weibull_cohort, conf.int = T)
```

``` {r weibull_chf, include = FALSE}
weibull_chf <- survreg(
  Surv(time = lenfol, event = fstat) ~ chf,
  data = d,
  dist = "weibull"
)

summary(weibull_chf)

tidy(weibull_chf, conf.int = T)
```

``` {r weibull_multi, include = FALSE}
weibull_multi <- survreg(
  Surv(time = lenfol, event = fstat) ~ age + sex + lenstay + yrgrp + chf,
  data = d,
  dist = "weibull"
)

summary(weibull_multi)

tidy(weibull_multi, conf.int = T)
```

``` {r sex_difference, echo = FALSE}
st <- survfit(
  Surv(time = lenfol, event = fstat) ~ sex,
  data = d
)

ggsurvplot(
  st, data = d,
  xlab = "Time",
  legend.labs = c("Male", "Female"),
  risk.table = "abs_pct",
  pval = T, pval.coord = c(30, 0.75),
  pval.method = T, pval.method.coord = c(30, 0.85),
  fontsize = 2.5
)
```

``` {r model_comparison, echo = FALSE}
# This code chunk is thanks to https://rstudio-pubs-static.s3.amazonaws.com/5564_bc9e2d9a458c4660aa82882df90b7a6b.html
# KM by lvh
km_chf <- npsurv(
  Surv(time = lenfol, event = fstat) ~ chf,
  data = d
)

## Plot KM curves
survplot(fit  = km_chf,
         conf = c("none","bands","bars")[1],
         xlab = "", ylab = "Survival",
         label.curves = TRUE,                     # label curves directly
         # time.inc = 100,                          # time increment
         n.risk   = TRUE,                         # show number at risk
         )

## Plot Cox prediction (use survfit)
lines(
  survfit(cox_univ_chf, newdata = data.frame(chf = 0:1)), 
  col = "green", lty = 1:2, mark.time = FALSE
)

## Define a function to plot survreg prediction by gender
survreg.curves <- function(
  model, 
  col = "black", 
  values = c(0, 1),
  seq.quantiles = seq(from = 0.00, to = 1.00, by = 0.01)
) {
  l_ply(
    values, 
    function(X) {
      lines(x = predict(
        model,                    # survreg object to use
        newdata = data.frame(chf = X), # Dataset to perform prediction for
        type = "quantile",                # Predict survival time (X-axis values) given event quantile
        p = seq.quantiles),               # Vector of quantiles (Y-axis values)
        y = (1 - seq.quantiles),              # Change to survival quantile (proportion remaining)
        col = col, lty = X + 1)               # COLor and Line TYpe
    }
  )
}

## Plot exponential model prediction
survreg.curves(exp_chf, "red")

## Plot Weibull model prediction
survreg.curves(weibull_chf, "blue")

## Add legends
legend(
  x = "topright",
  legend = c("Kaplan-Meier", "Cox (Efron)", "Exponential", "Weibull"),
  lwd = 2, bty = "n",
  col = c("black", "green", "red", "blue")
)

```
